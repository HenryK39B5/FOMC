<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOMC经济数据浏览器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --card-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --card-border: 1px solid rgba(0, 0, 0, 0.125);
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), #1a2530);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .card {
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .indicator-category {
            margin-bottom: 0.3rem;
        }
        
        .category-header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.4rem 0.6rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.15rem;
            font-size: 0.85rem;
        }
        
        .category-header:hover {
            background-color: #1a2530;
        }
        
        .indicator-list {
            padding: 0.15rem;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .indicator-item {
            padding: 0.3rem 0.4rem;
            margin-bottom: 0.15rem;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }
        
        .indicator-item:hover {
            background-color: #e9f7fe;
            border-color: var(--secondary-color);
            transform: translateX(3px);
        }
        
        .indicator-item.active {
            background-color: #d1ecf1;
            border-color: #3498db;
        }
        
        .fred-link {
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .fred-link:hover {
            color: #0d6efd !important;
            text-decoration: underline;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 1rem;
        }
        
        .data-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .footer {
            background-color: var(--dark-bg);
            color: white;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }
        
        .filter-section {
            background: linear-gradient(to right, #edf2f7, #e2e8f0);
            padding: 1.25rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
        }
        
        .filter-section .form-label {
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .btn-light {
            background-color: white;
            border-color: #ddd;
        }
        
        .btn-light:hover {
            background-color: #f8f9fa;
            border-color: #ccc;
        }
        
        .table-dark {
            background-color: var(--primary-color);
        }

        .report-chart-placeholder {
            min-height: 320px;
            border: 1px dashed #ced4da;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            padding: 1rem;
            text-align: center;
        }

        .report-text-box {
            min-height: 320px;
            border: var(--card-border);
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #fff;
            overflow-y: auto;
        }

        .report-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }

        #reportText {
            white-space: pre-line;
        }
        
        /* 响应式设计增强 */
        @media (max-width: 768px) {
            .header {
                padding: 1rem 0;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .filter-section {
                padding: 1rem;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .data-table-container {
                max-height: 300px;
            }
            
            .footer {
                text-align: center;
            }
            
            /* 在小屏幕上改为垂直布局 */
            .sidebar-col {
                margin-bottom: 1.5rem;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .filter-section .row > div {
                margin-bottom: 1rem;
            }
            
            .filter-section .row > div:last-child {
                margin-bottom: 0;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .card-body {
                padding: 1rem;
            }
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 滚动条样式 */
        .data-table-container::-webkit-scrollbar, .indicator-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .data-table-container::-webkit-scrollbar-track, .indicator-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .data-table-container::-webkit-scrollbar-thumb, .indicator-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .data-table-container::-webkit-scrollbar-thumb:hover, .indicator-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 折叠图标动画 */
        .collapse-icon {
            transition: transform 0.3s ease;
        }
        
        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-bar-chart-line"></i> FOMC经济数据浏览器</h1>
                    <p class="mb-0">美联储公开市场委员会经济指标数据可视化平台</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-light" id="refreshBtn">
                        <i class="bi bi-arrow-repeat"></i> 刷新数据
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="row">
            <!-- 左侧指标选择区 -->
            <div class="col-lg-3 sidebar-col">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> 经济指标分类</h5>
                    </div>
                    <div class="card-body">
                        <div id="indicatorHierarchy">
                            <!-- 动态填充指标层级结构 -->
                        </div>
                    </div>
                </div>
                
                <!-- 过滤器区域 -->
                <div class="card mt-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-funnel"></i> 数据过滤器</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="dateRange" class="form-label">时间范围</label>
                            <select class="form-select" id="dateRange">
                                <option value="1Y">最近1年</option>
                                <option value="3Y" selected>最近3年</option>
                                <option value="5Y">最近5年</option>
                                <option value="10Y">最近10年</option>
                                <option value="all">全部数据</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sortOrder" class="form-label">排序方式</label>
                            <select class="form-select" id="sortOrder">
                                <option value="date_desc">按日期降序</option>
                                <option value="date_asc">按日期升序</option>
                                <option value="value_desc">按数值降序</option>
                                <option value="value_asc">按数值升序</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧数据展示区 -->
            <div class="col-lg-9">
                <!-- 图表区域 -->
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-graph-up"></i> 数据趋势图</h5>
                            <small id="currentIndicator" class="text-white-50">请选择一个经济指标</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-light me-2" id="lineChartBtn">折线图</button>
                            <button class="btn btn-sm btn-light" id="barChartBtn">柱状图</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="dataChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 数据表格 -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-table"></i> 数据表格</h5>
                    </div>
                    <div class="card-body">
                        <div class="data-table-container">
                            <table class="table table-striped table-hover" id="dataTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>指标名称</th>
                                        <th>日期</th>
                                        <th>数值</th>
                                        <th>单位</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态填充数据行 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 研报生成区域 -->
                <div class="card mt-4">
                    <div class="card-header bg-dark text-white d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                        <div>
                            <h5 class="mb-1"><i class="bi bi-journal-text"></i> 自动生成非农研报</h5>
                            <small class="text-white-50">选择月份后，系统会绘制图表并调用DeepSeek生成分析文本</small>
                        </div>
                        <div class="mt-3 mt-md-0">
                            <button class="btn btn-light" id="generateReportBtn">
                                <i class="bi bi-play-circle"></i> 生成图表与研报
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-sm-6 col-lg-4">
                                <label for="reportType" class="form-label">报告类型</label>
                                <select class="form-select" id="reportType" disabled>
                                    <option value="nonfarm" selected>非农就业 + 失业率</option>
                                </select>
                            </div>
                            <div class="col-sm-6 col-lg-4">
                                <label for="reportMonth" class="form-label">报告月份</label>
                                <input type="month" class="form-control" id="reportMonth">
                            </div>
                            <div class="col-lg-4 text-lg-end">
                                <div id="reportStatus" class="report-meta">请选择月份后点击生成。</div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-lg-6 mb-3 mb-lg-0">
                                <div class="report-chart-placeholder" id="reportChartPlaceholder">
                                    <img id="reportChartImage" class="img-fluid d-none" alt="劳动力市场图表">
                                    <div id="reportChartEmpty">图表尚未生成</div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="report-text-box" id="reportTextBox">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">研报内容</h6>
                                        <span class="badge bg-secondary" id="reportHeadlineBadge">待生成</span>
                                    </div>
                                    <div id="reportText" class="text-muted">生成研报后将在此展示全文。</div>
                                    <div id="llmError" class="text-danger small mt-2 d-none"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h6>关键指标摘要</h6>
                            <ul class="list-group list-group-flush" id="indicatorSummary">
                                <li class="list-group-item text-muted">暂无数据，请先生成一次研报。</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">&copy; 2025 FOMC经济数据分析项目</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">数据来源: Federal Reserve Economic Data (FRED)</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentChart = null;
        let chartType = 'line'; // 默认图表类型
        let activeIndicatorId = null; // 当前选中的指标ID

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadIndicators();
            loadDataTable();
            initializeChart();
            initializeReportModule();
            
            // 绑定事件监听器
            document.getElementById('dateRange').addEventListener('change', updateVisualization);
            document.getElementById('sortOrder').addEventListener('change', updateVisualization);
            document.getElementById('lineChartBtn').addEventListener('click', function() {
                chartType = 'line';
                updateVisualization();
            });
            document.getElementById('barChartBtn').addEventListener('click', function() {
                chartType = 'bar';
                updateVisualization();
            });
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
        });

        // 显示消息
        function showMessage(message, type) {
            // 移除现有的消息
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // 创建新的消息元素
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // 插入到页面顶部
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // 显示加载状态
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                // 特殊处理表格元素
                if (elementId === 'dataTable') {
                    const tbody = element.querySelector('tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2">加载中...</p></td></tr>';
                    }
                } else {
                    element.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2">加载中...</p></div>';
                }
            }
        }

        // 显示错误信息
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                // 特殊处理表格元素
                if (elementId === 'dataTable') {
                    const tbody = element.querySelector('tbody');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-4">加载失败: ${message}</td></tr>`;
                    }
                } else {
                    element.innerHTML = `<div class="alert alert-danger text-center py-4">加载失败: ${message}</div>`;
                }
            }
        }

        // 加载经济指标列表的层级结构
        function loadIndicators() {
            fetch('/api/indicators')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    const hierarchyContainer = document.getElementById('indicatorHierarchy');
                    hierarchyContainer.innerHTML = '';
                    
                    // 递归函数，用于构建层级结构的HTML
                    function buildHierarchyHTML(items, level = 0) {
                        let html = '';
                        items.forEach(item => {
                            if (item.type === 'category') {
                                const categoryId = `category-${item.id}`;
                                const iconClass = level === 0 ? 'bi-folder-fill' : 'bi-folder2-open';
                                const paddingStyle = level > 0 ? `style="padding-left: ${level * 10}px"` : '';
                                
                                html += `
                                    <div class="indicator-category mb-2" ${paddingStyle}>
                                        <div class="category-header" data-bs-toggle="collapse" data-bs-target="#${categoryId}">
                                            <span><i class="bi ${iconClass} me-2"></i>${item.name}</span>
                                            <i class="bi bi-chevron-down collapse-icon"></i>
                                        </div>
                                        <div class="collapse show indicator-list" id="${categoryId}">
                                            ${item.children && item.children.length > 0 ? buildHierarchyHTML(item.children, level + 1) : ''}
                                        </div>
                                    </div>
                                `;
                            } else if (item.type === 'indicator') {
                                const paddingStyle = `style="padding-left: ${(level + 1) * 10}px"`;
                                html += `
                                    <div class="indicator-item" data-id="${item.id}" data-fred-url="${item.fred_url}" ${paddingStyle}>
                                        <div class="fw-bold">${item.name}</div>
                                        <small class="text-muted">${item.code}</small>
                                        <div class="mt-1">
                                            <a href="${item.fred_url}" target="_blank" class="fred-link text-primary" style="font-size: 0.75rem;">
                                                <i class="bi bi-box-arrow-up-right"></i> FRED数据
                                            </a>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        return html;
                    }
                    
                    // 构建并插入层级结构HTML
                    hierarchyContainer.innerHTML = buildHierarchyHTML(data);
                    
                    // 为所有指标项添加点击事件
                    document.querySelectorAll('.indicator-item').forEach(item => {
                        item.addEventListener('click', () => selectIndicator(item.dataset.id));
                    });
                })
                .catch(error => {
                    console.error('加载指标列表失败:', error);
                    const hierarchyContainer = document.getElementById('indicatorHierarchy');
                    hierarchyContainer.innerHTML = `<div class="alert alert-danger">加载指标列表失败: ${error.message}</div>`;
                });
        }

        // 加载数据表格
        function loadDataTable() {
            showLoading('dataTable');
            fetch('/api/data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    const tbody = document.querySelector('#dataTable tbody');
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center">暂无数据</td></tr>';
                        return;
                    }
                    data.forEach(point => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${point.indicator_name}</td>
                            <td>${point.date}</td>
                            <td>${point.value}</td>
                            <td>${point.units}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('加载数据表格失败:', error);
                    const tbody = document.querySelector('#dataTable tbody');
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
                });
        }

        // 初始化图表
        function initializeChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '经济指标数据',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // 更新可视化
        function updateVisualization() {
            const indicatorId = activeIndicatorId;
            const dateRange = document.getElementById('dateRange').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            // 如果没有选中任何指标，则不更新
            if (!indicatorId) {
                return;
            }
            
            // 显示图表加载状态
            if (currentChart) {
                currentChart.destroy();
            }
            const chartCtx = document.getElementById('dataChart').getContext('2d');
            currentChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '加载中...',
                        data: [],
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        backgroundColor: 'rgba(0, 0, 0, 0.05)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // 显示表格加载状态
            showLoading('dataTable');
            
            // 更新图表
            fetch(`/api/chart-data?indicator_id=${indicatorId}&date_range=${dateRange}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    if (currentChart) {
                        currentChart.destroy();
                    }
                    
                    const ctx = document.getElementById('dataChart').getContext('2d');
                    // 构建包含单位的图表标题
                    const chartTitle = data.indicator_units ? 
                        `${data.indicator_name} (${data.indicator_units})` : 
                        data.indicator_name;
                    
                    currentChart = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: data.dates,
                            datasets: [{
                                label: chartTitle,
                                data: data.values,
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: chartType === 'line' ? 'rgba(54, 162, 235, 0.2)' : 'rgba(54, 162, 235, 0.6)',
                                tension: 0.1,
                                fill: chartType === 'line'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    labels: {
                                        font: {
                                            size: 14
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        size: 14
                                    },
                                    bodyFont: {
                                        size: 13
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('更新图表失败:', error);
                    if (currentChart) {
                        currentChart.destroy();
                    }
                    const ctx = document.getElementById('dataChart').getContext('2d');
                    currentChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: '加载失败',
                                data: [],
                                borderColor: 'rgba(255, 0, 0, 0.5)',
                                backgroundColor: 'rgba(255, 0, 0, 0.1)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                });
            
            // 更新表格
            fetch(`/api/data?indicator_id=${indicatorId}&date_range=${dateRange}&sort_order=${sortOrder}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    const tbody = document.querySelector('#dataTable tbody');
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center">暂无数据</td></tr>';
                        return;
                    }
                    data.forEach(point => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${point.indicator_name}</td>
                            <td>${point.date}</td>
                            <td>${point.value}</td>
                            <td>${point.units}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('更新数据表格失败:', error);
                    const tbody = document.querySelector('#dataTable tbody');
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
                });
        }

        // 选择指标
        function selectIndicator(indicatorId) {
            // 更新活动状态
            activeIndicatorId = indicatorId;
            
            // 更新UI上的活动状态
            document.querySelectorAll('.indicator-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`.indicator-item[data-id="${indicatorId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            // 获取指标名称并显示在页面上
            const indicatorName = selectedItem.querySelector('.fw-bold').textContent;
            const indicatorCode = selectedItem.querySelector('.text-muted').textContent;
            const fredUrl = selectedItem.dataset.fredUrl;
            
            // 更新当前选中的指标显示，添加FRED链接
            const currentIndicatorElement = document.getElementById('currentIndicator');
            if (currentIndicatorElement) {
                currentIndicatorElement.innerHTML = `${indicatorName} (${indicatorCode}) <a href="${fredUrl}" target="_blank" class="text-white-50 ms-2" style="font-size: 0.8rem;"><i class="bi bi-box-arrow-up-right"></i> FRED</a>`;
            }
            
            // 更新可视化
            updateVisualization();
        }

        // 刷新数据
        function refreshData() {
            // 显示刷新状态
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 刷新中...';
            refreshBtn.disabled = true;
            
            fetch('/api/refresh-data', { method: 'POST' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    // 显示成功消息
                    showMessage(data.message, 'success');
                    loadIndicators();
                    loadDataTable();
                    updateVisualization();
                })
                .catch(error => {
                    console.error('刷新数据失败:', error);
                    showMessage('数据刷新失败: ' + error.message, 'danger');
                })
                .finally(() => {
                    // 恢复按钮状态
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    }, 1000);
                });
        }

        // -------------------------------
        // 研报生成相关逻辑
        // -------------------------------
        function initializeReportModule() {
            const monthInput = document.getElementById('reportMonth');
            if (monthInput) {
                const now = new Date();
                const monthValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                monthInput.value = monthValue;
            }
            const generateBtn = document.getElementById('generateReportBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', handleReportGeneration);
            }
        }

        function handleReportGeneration() {
            const reportMonth = document.getElementById('reportMonth').value;
            if (!reportMonth) {
                showMessage('请先选择报告月份', 'warning');
                return;
            }
            setReportLoading(true, '正在生成图表与研报...');
            fetch('/api/labor-market/report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ report_month: reportMonth })
            })
            .then(response => response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error || '生成失败');
                }
                return data;
            }))
            .then(data => {
                updateReportUI(data);
            })
            .catch(error => {
                console.error('生成研报失败:', error);
                showMessage('生成研报失败: ' + error.message, 'danger');
                setReportLoading(false, '生成失败，请重试');
            });
        }

        function setReportLoading(isLoading, statusText) {
            const button = document.getElementById('generateReportBtn');
            const status = document.getElementById('reportStatus');
            if (button) {
                if (isLoading) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> 处理中...';
                } else {
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-play-circle"></i> 生成图表与研报';
                }
            }
            if (status && statusText) {
                status.textContent = statusText;
            } else if (status && !isLoading) {
                status.textContent = '生成完成，可重新选择月份。';
            }
        }

        function updateReportUI(data) {
            const windowInfo = data.chart_window;
            const windowText = windowInfo ? `图表区间: ${windowInfo.start_date} - ${windowInfo.end_date}` : '生成完成';
            setReportLoading(false, windowText);
            updateReportChart(data.chart_image);
            updateIndicatorSummary(data.indicators);
            updateReportText(data.report_text, data.llm_error, data.headline_summary);
        }

        function updateReportChart(imageBase64) {
            const img = document.getElementById('reportChartImage');
            const placeholder = document.getElementById('reportChartEmpty');
            if (imageBase64 && img) {
                img.src = `data:image/png;base64,${imageBase64}`;
                img.classList.remove('d-none');
                if (placeholder) {
                    placeholder.classList.add('d-none');
                }
            } else {
                if (img) {
                    img.classList.add('d-none');
                }
                if (placeholder) {
                    placeholder.classList.remove('d-none');
                    placeholder.textContent = '无法生成图表';
                }
            }
        }

        function updateIndicatorSummary(indicators) {
            const list = document.getElementById('indicatorSummary');
            if (!list) return;
            if (!indicators || indicators.length === 0) {
                list.innerHTML = '<li class="list-group-item text-muted">暂无数据</li>';
                return;
            }
            list.innerHTML = '';
            indicators.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                const deltas = [];
                if (item.mom_change) {
                    deltas.push(`环比: ${item.mom_change}`);
                }
                if (item.yoy_change) {
                    deltas.push(`同比: ${item.yoy_change}`);
                }
                const deltaText = deltas.length ? `（${deltas.join('，')}）` : '';
                const contextText = item.context ? `<div class="small text-muted">${item.context}</div>` : '';
                li.innerHTML = `<strong>${item.name}</strong>: ${item.latest_value}${item.units}${deltaText}${contextText}`;
                list.appendChild(li);
            });
        }

        function updateReportText(reportText, llmError, headline) {
            const reportEl = document.getElementById('reportText');
            const errorEl = document.getElementById('llmError');
            const badgeEl = document.getElementById('reportHeadlineBadge');

            if (badgeEl && headline) {
                badgeEl.textContent = headline;
                badgeEl.classList.remove('bg-secondary');
                badgeEl.classList.add('bg-primary');
            }

            if (reportEl) {
                if (reportText) {
                    reportEl.textContent = reportText;
                    reportEl.classList.remove('text-muted');
                } else {
                    reportEl.textContent = '未能生成研报内容，请检查DeepSeek配置。';
                    reportEl.classList.add('text-muted');
                }
            }

            if (errorEl) {
                if (llmError) {
                    errorEl.textContent = llmError;
                    errorEl.classList.remove('d-none');
                } else {
                    errorEl.classList.add('d-none');
                }
            }
        }
    </script>
</body>
</html>
