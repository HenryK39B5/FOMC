{% extends "base.html" %}

{% block content %}
<div class="hero-card" style="margin-bottom: 20px;">
  <div class="pill">研报工作台</div>
  <h1>非农 / CPI 研报一键生成</h1>
  <p class="lede">选择月份即可复用现有数据管线生成图表与摘要，并串联 DeepSeek 研报文本。结果直接显示在页面，也可以在 API 层复用。</p>
</div>

<div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 16px;">
  <div class="panel">
    <h3>非农 + 失业率</h3>
    <div class="field-row">
      <input id="labor-month" type="month" value="{{ default_month }}">
      <button class="btn" id="btn-labor">生成</button>
    </div>
    <div id="labor-status" class="muted"></div>
    <div id="labor-result" class="results"></div>
  </div>

  <div class="panel">
    <h3>CPI 研判</h3>
    <div class="field-row">
      <input id="cpi-month" type="month" value="{{ default_month }}">
      <button class="btn" id="btn-cpi">生成</button>
    </div>
    <div id="cpi-status" class="muted"></div>
    <div id="cpi-result" class="results"></div>
  </div>
</div>

<script>
  const renderMarkdownLite = (text = "") => {
    const escapeHtml = (str) => str.replace(/[&<>]/g, (ch) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[ch] || ch));
    const lines = text.split(/\r?\n/);
    let html = "";
    for (const line of lines) {
      if (!line.trim()) {
        html += "<br>";
        continue;
      }
      if (line.startsWith("## ")) {
        html += `<h4>${escapeHtml(line.replace("## ", ""))}</h4>`;
      } else if (line.startsWith("- ")) {
        html += `<div class="pill-inline">• ${escapeHtml(line.slice(2))}</div>`;
      } else {
        html += `<p>${escapeHtml(line)}</p>`;
      }
    }
    return html;
  };

  const summarizeIndicators = (list = []) =>
    list
      .map((item) => `${item.name}: ${item.latest_value}${item.units || ""}${item.mom_change ? "（环比" + item.mom_change + "）" : ""}`)
      .join(" · ");

  async function callApi(url, statusEl, resultEl, onSuccess) {
    statusEl.textContent = "加载中…";
    resultEl.innerHTML = "";
    try {
      const resp = await fetch(url);
      const data = await resp.json();
      if (!resp.ok) {
        throw new Error(data.detail || data.error || "请求失败");
      }
      statusEl.textContent = "";
      onSuccess(data, resultEl);
    } catch (err) {
      statusEl.textContent = err.message || "请求失败";
      statusEl.style.color = "#f87171";
    }
  }

  document.getElementById("btn-labor").addEventListener("click", () => {
    const month = document.getElementById("labor-month").value;
    callApi(`/api/reports/labor?month=${month}`, document.getElementById("labor-status"), document.getElementById("labor-result"), (data, el) => {
      const insight = summarizeIndicators(data.indicators || []);
      const llmBlock = data.report_text
        ? `<div class="summary-card">${renderMarkdownLite(data.report_text)}</div>`
        : `<div class="muted">LLM 未返回正文：${data.llm_error || "未配置 DEEPSEEK_API_KEY"}</div>`;
      el.innerHTML = `
        <div class="card">
          <div class="title">结论｜${data.headline_summary || "缺少数据"}</div>
          <div class="muted">窗口 ${data.chart_window?.start_date} → ${data.chart_window?.end_date}</div>
          <div class="chips">${(data.indicators || []).map(() => '<span class="chip">指标</span>').join("")}</div>
          <div class="summary-card">
            <div class="pill-inline">指标快照：${insight || "暂无数据"}</div>
            <p class="muted">${data.chart_commentary || ""}</p>
          </div>
          ${llmBlock}
        </div>
      `;
    });
  });

  document.getElementById("btn-cpi").addEventListener("click", () => {
    const month = document.getElementById("cpi-month").value;
    callApi(`/api/reports/cpi?month=${month}`, document.getElementById("cpi-status"), document.getElementById("cpi-result"), (data, el) => {
      const insight = summarizeIndicators(data.indicators || []);
      const llmBlock = data.report_text
        ? `<div class="summary-card">${renderMarkdownLite(data.report_text)}</div>`
        : `<div class="muted">LLM 未返回正文：${data.llm_error || "未配置 DEEPSEEK_API_KEY"}</div>`;
      el.innerHTML = `
        <div class="card">
          <div class="title">结论｜${data.headline_summary || "缺少数据"}</div>
          <div class="pill-inline">指标快照：${insight || "暂无数据"}</div>
          <div class="muted">${data.chart_commentary || ""}</div>
          ${llmBlock}
        </div>
      `;
    });
  });
</script>
{% endblock %}
