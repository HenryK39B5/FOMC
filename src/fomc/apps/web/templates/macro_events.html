{% extends "base.html" %}

{% block content %}
<div class="hero-card" style="margin-bottom: 20px;">
  <div class="pill">宏观事件月报</div>
  <h1>自动收集当月宏观事件并生成月报</h1>
  <p class="lede">调用 DDG 搜索与 LLM 聚合，输出事件时间线与 Markdown 月报。与研报工作台同入口访问，数据写入统一的数据库位置。</p>
</div>

<div class="panel">
  <div class="field-row">
    <input id="macro-month" type="month" value="{{ default_month }}">
    <button class="btn" id="btn-macro-fetch">读取</button>
    <button class="btn secondary" id="btn-macro-refresh">重新抓取</button>
  </div>
  <div id="macro-status" class="muted"></div>
  <div class="results" id="macro-result"></div>
</div>

<script>
  const renderSummary = (html) => {
    if (!html) return '<div class="muted">尚未生成月报摘要</div>';
    return `<div class="summary-card">${html}</div>`;
  };

  const renderEvents = (events = []) => {
    if (!events.length) return '<div class="muted">暂无事件</div>';
    return events
      .map(
        (e) => `
        <div class="event">
          <div class="meta">
            <span>${e.date || "日期未明"}</span>
            <span class="chip">${(e.macro_shock_type || "其他").replaceAll("_", " ")}</span>
          </div>
          <h4>${e.title || "未命名事件"}</h4>
          <div class="summary">${e.summary || "暂无摘要"}</div>
        </div>
      `
      )
      .join("");
  };

  async function fetchMacro(refresh = false) {
    const month = document.getElementById("macro-month").value;
    const status = document.getElementById("macro-status");
    const result = document.getElementById("macro-result");
    status.textContent = refresh ? "重新抓取中…" : "读取中…";
    result.innerHTML = "";
    try {
      const resp = await fetch(`/api/macro-events?month=${month}${refresh ? "&refresh=true" : ""}`);
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.detail || data.error || "请求失败");
      status.textContent = "";
      result.innerHTML = `
        <div class="card">
          <div class="title">月份 ${data.month_key}</div>
          <div class="muted">事件 ${data.num_events || data.events?.length || 0} 条，状态 ${data.status || "unknown"}</div>
          ${renderSummary(data.monthly_summary_html)}
          <h3 class="section-title">事件时间线</h3>
          <div class="grid">${renderEvents(data.events)}</div>
        </div>
      `;
    } catch (err) {
      status.textContent = err.message || "请求失败";
      status.style.color = "#f87171";
    }
  }

  document.getElementById("btn-macro-fetch").addEventListener("click", () => fetchMacro(false));
  document.getElementById("btn-macro-refresh").addEventListener("click", () => fetchMacro(true));
</script>
{% endblock %}
